- fail:
    msg: You need to specify exactly one host running Galaxy.
  when: "{{ groups.galaxy|length != 1}}"

- name: Add server name to the apache.conf
  lineinfile:
      dest: "/etc/apache2/apache2.conf"
      regexp: ^ServerName
      line: "ServerName {{ inventory_hostname }}"
      state: present

- name: Ensure locale is en_US.UTF-8
  lineinfile:
      dest: /etc/default/locale
      regexp: LC_ALL
      line: "LC_ALL=\"en_US.UTF-8\""

- name: Install required packages
  apt:
      name: "{{ item }}"
      state: latest
  with_items:
      - git
      # Galaxy needs python 2.7.
      - python

- name: Clone galaxy repo
  git:
      repo: "{{ galaxy_repo }}"
      dest: "{{ galaxy_directory }}"
      clone: yes
      version: "{{ galaxy_version }}"
      accept_hostkey: yes

- name: Create object store
  file:
      path: "{{ object_store_directory }}"
      state: directory

- name: Create galaxy.ini file
  copy:
      remote_src: True
      src: "{{ galaxy_directory }}/config/galaxy.ini.sample"
      dest: "{{ galaxy_directory }}/config/galaxy.ini"

- name: Set job working directory 
  lineinfile:
      dest: "{{ galaxy_directory }}/config/galaxy.ini"
      regexp: ^(#?)+job_working_directory\s?=
      line: "job_working_directory = {{ object_store_directory }}/{{ job_working_directory }}"
      state: present

- name: Set file directory
  lineinfile:
      dest: "{{ galaxy_directory }}/config/galaxy.ini" 
      regexp: ^(#?)+file_path\s?=
      line: "file_path = {{ object_store_directory }}/{{ files_directory }}"
      state: present

- name: Set tmp directory 
  lineinfile:
      dest: "{{ galaxy_directory }}/config/galaxy.ini"
      regexp: ^(#?)+new_file_path\s?=
      line: "new_file_path = {{ object_store_directory }}/{{ tmp_directory }}"
      state: present

- name: Clone SADI repo
  git:
      repo: https://github.com/mikel-egana-aranguren/SADI-Docker-Galaxy.git
      dest: "{{ sadi_directory }}"
      clone: yes
  when: "{{ install_sadi }}"

- name: Create tool_conf.xml file
  copy:
      remote_src: True
      src: "{{ galaxy_directory }}/config/tool_conf.xml.sample"
      dest: "{{ galaxy_directory }}/config/tool_conf.xml"

- name: Copy SADI tools
  command: "cp -R {{ sadi_directory }}/tools/SADI-Docker {{ galaxy_directory }}/tools"
  when: "{{ install_sadi }}"

- name: Add SADI section to tool_conf.xml
  blockinfile:
      dest: "{{ galaxy_directory }}/config/tool_conf.xml"
      insertbefore: </toolbox>
      block: |
          <section id="SADI-Docker" name="Docker SADI services">
              <tool file="SADI-Docker/SADI-Docker-sadi_client.xml"/>
              <tool file="SADI-Docker/SADI-Docker-RDFSyntaxConverter.xml"/>
              <tool file="SADI-Docker/SADI-Docker-mergeRDFgraphs.xml"/>
              <tool file="SADI-Docker/SADI-Docker-SPARQLGalaxy.xml"/>
              <tool file="SADI-Docker/SADI-Docker-rapper.xml"/>
              <tool file="SADI-Docker/SADI-Docker-tab2rdf.xml"/>
          </section>
  when: "{{ install_sadi }}"

- name: Apply migrations
  command: sh manage_db.sh upgrade
  args:
      chdir: "{{ galaxy_directory }}"

- name: Start galaxy
  command: sh run.sh --daemon
  args:
      chdir: "{{ galaxy_directory }}"
